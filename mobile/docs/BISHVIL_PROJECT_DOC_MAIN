# Bishvil ‚Äì Project Documentation

*Last updated: 2026-01-07*

This document consolidates the project documentation into four clear layers:

1. **Product Specification** ‚Äì what the product is and is not
2. **Architecture & Decisions** ‚Äì stable, long‚Äëterm choices
3. **Current Status** ‚Äì factual snapshot of where the project stands
4. **Execution Plan (TODO)** ‚Äì forward‚Äëlooking, actionable work

---

## 1. Product Specification (Stable)

### Purpose

Bishvil is an **Android‚Äëfirst mobile app** for organizing and joining cycling rides in Israel (MTB / Gravel / Road), optimized for *operational compatibility* (pace, skill, timing, gender preferences) rather than social networking.

### Core Principles

* Fast ride discovery and joining
* Low friction, minimal ceremony
* Privacy‚Äëfirst (no phone exposure)
* Hebrew‚Äëfirst with full RTL/LTR support
* Gender-aware ride filtering for safety and comfort
* Social trust through organizer transparency

### Target Platform

* Android first (APK distribution via direct download)
* iOS later (no architectural blockers)

### MVP Scope

* Ride creation and discovery
* Join / approval flows
* Profiles (lightweight, preference-based)
* Map‚Äëbased location selection (Israel Hiking Map)
* Bilingual UI (Hebrew / English)
* Push notifications for ride events
* Gender-based ride filtering
* Organizer display with ride statistics
* Deep linking for ride sharing

### Explicitly Out of Scope (MVP)

* GPS ride tracking during rides
* Media uploads (photos/videos)
* Social feeds, likes, ratings
* Internal moderation tools
* In-app chat (WhatsApp used instead)
* Ride editing after creation
* User search / following (reserved for future)
* Clickable user profiles (foundation laid, not implemented)

### KPIs (Pilot)

* Time to first joined ride
* % of rides that actually happen
* Repeat rides with the same participants
* Notification engagement rate
* Deep link conversion rate (shared ‚Üí opened ‚Üí joined)

---

## 2. Architecture & Decisions (Long‚ÄëTerm)

### Mobile Stack

* **Framework:** React Native + Expo SDK 52 (TypeScript)
* **UI Library:** react-native-paper (Material Design 3)
* **Navigation:** React Navigation (native stack + bottom tabs)
* **Design:** Strava‚Äëinspired dark theme, clean, functional aesthetic
* **Storage:** AsyncStorage for user preferences (filters, theme)

### Backend

* **Platform:** Supabase
  * Auth: Phone OTP (email fallback for development)
  * PostgreSQL with Row Level Security (RLS)
  * Realtime subscriptions for live updates
  * Edge Functions for notifications
  * Database webhooks for event triggers
  * Foreign key relationships for data integrity

### Authentication

* Phone OTP primary (Israeli norm, high completion)
* Email auth for development/testing
* Sessions persist across app restarts
* Auto-refresh of push tokens on login

### Data Model

#### Core Tables
* `profiles` - User profiles (separate from auth.users)
  * Auto-created via DB trigger
  * Contains: display_name, bio, ride_type[], skill, pace, birth_year, gender, expo_push_token
  * **Future:** Will add rides_organized_count, rides_joined_count for performance
  
* `rides` - Ride listings
  * Contains ride details, location, preferences, gender_preference
  * Foreign key: owner_id ‚Üí profiles.id (rides_owner_profile_id_fkey)
  * Status: draft, published, cancelled, completed (future automation)
  
* `ride_participants` - Join/approval tracking
  * Tracks status: joined, requested, rejected, left, kicked
  * Foreign key: user_id ‚Üí profiles.id

### Privacy Decisions

* Phone numbers never exposed to other users
* Display name is the only visible identity
* Organizer name and stats visible for trust building
* Future contact via in‚Äëapp notifications or WhatsApp link only
* No public user profiles yet (foundation exists for future)

### Maps & Location

* **Provider:** Mapbox GL (native build required)
* **Tiles:** Israel Hiking Map with colored trail overlays
* **Features:**
  * Full-screen map picker for ride creation
  * Interactive map preview in ride details
  * Text description + GPS coordinates required
  * External navigation (Google Maps / Waze)
* **Design Decision:** No reverse geocoding (user provides text description)

### Notifications

* **Provider:** Expo Push Notifications + Firebase Cloud Messaging
* **Architecture:**
  * Supabase Database Webhooks ‚Üí Edge Function ‚Üí Expo Push API
  * Token stored in profiles table, auto-refreshed on app start
  * Android notification channels for categorization
* **Events:**
  * Join requests (to owner)
  * Approval/rejection (to requester)
  * Ride cancellation (to all participants)
  * Ride updates (future)

### Deep Linking

* **Architecture:**
  * React Navigation's built-in linking configuration
  * Prefixes: `bishvil://`, `https://bishvil.app`, `https://bishvil-app.vercel.app`
* **Route Strategy:**
  * External shared links ‚Üí FeedStack ‚Üí RideDetails
  * MyRides internal navigation ‚Üí MyRidesStack ‚Üí RideDetails
  * Unique patterns prevent conflicts: `ride/:rideId` vs `my-rides/ride/:rideId`
* **Features:**
  * Works in cold start (app closed) and warm start (app open)
  * WhatsApp share integration
  * Native Android intent handling via MainActivity

### Internationalization

* **Languages:** Hebrew (primary), English
* **Implementation:** react-i18next
* **RTL Handling:** Native I18nManager.forceRTL() with app restart requirement
* **Date/Time:** Localized using he-IL formatting

### Real-Time Architecture

* **Technology:** Supabase Realtime (PostgreSQL Change Data Capture)
* **Implementation:**
  * MyRidesScreen: Subscribes to ride_participants and rides table changes
  * RideDetailsScreen: Subscribes to changes for specific ride
  * Feed: Uses useFocusEffect for manual refresh (sufficient for feed use case)
* **Benefits:** Instant updates across devices without polling or manual refresh

### Design System

* **Theme:** Dark mode (#121212 background)
* **Colors:**
  * Primary: #ff6b35 (orange) for selections and CTAs
  * Status badges: Orange (owner), Green (joined), Yellow (pending)
* **Spacing:**
  * Chip gaps: 6px
  * Section gaps: 16px
* **Typography:** Material Design 3 variants
* **Components:** Consistent chips, cards, buttons across all screens

### Deferred Backend (Reserved)

* FastAPI (Python) for future needs:
  * Moderation tools
  * Trust scoring algorithms
  * Scheduled cleanup jobs (ride status automation)
  * External service integrations
  * Counter field maintenance (rides_organized_count, rides_joined_count)

---

## 3. Current Project Status (Snapshot)

**Stage:** Production-Ready MVP with Social Trust Features

### ‚úÖ Completed Core Features

#### Authentication & Profiles
* Phone OTP authentication with persistent sessions
* Profile auto-creation via DB trigger
* Lightweight profile with ride preferences
* Gender selection (Male/Female/Other)
* Birth year collection
* Ride type preferences (Trail, Enduro, Gravel, Road)
* Skill level and pace preferences

#### Ride Creation & Management
* 5-step wizard (When/Where/Details/Group/Review)
  * Date/time picker with duration
  * Full-screen map location picker (Israel Hiking Map)
  * Ride type, skill level, pace selection
  * Distance and elevation (optional)
  * Max participants (1-6, recommendation for 4)
  * Join mode (Express/Approval)
  * Gender preference (All/Men/Women)
* Owner can cancel rides (notifies all participants)
* Participants can leave rides
* Real-time participant count updates

#### Feed & Discovery
* Smart filtering by:
  * User's preferred ride types (auto-loaded from profile)
  * User's gender (automatic gender-based visibility)
  * Skill level (optional)
  * Time range (Today, 3d, 7d, 14d, 30d)
  * **Persistent filters** - saved to AsyncStorage, restored on app start
* Empty states with helpful CTAs
* Pull-to-refresh
* Real-time updates via Supabase subscriptions
* **Organizer display** with ride statistics

#### My Rides
* Three sections with visual status indicators:
  * Organizing (orange badge)
  * Joined (green badge)
  * Requested (yellow badge)
* Empty states per section
* Status-specific ride cards
* **Real-time updates** - automatic refresh when participant status changes

#### Ride Details
* Complete ride information display
* **Organizer name and statistics** at top of card
* Israel Hiking Map preview
* Participant list with owner indicator
* Pending requests section (owner only)
* Approve/reject buttons (owner only)
* Join/Leave actions
* External navigation (Google Maps/Waze)
* **WhatsApp share with deep links**
* Gender preference display
* **Real-time updates** for participants and ride changes

#### Deep Linking System
* **Full deep link support** for ride sharing
* Works in cold start (app closed) and warm start (app running)
* WhatsApp integration for viral sharing
* Automatic navigation to correct ride details
* Conflict-free route patterns across navigation stacks

#### Organizer Display & Trust Signals ‚≠ê NEW
* **Organizer name visible** on all ride cards (Feed, MyRides, RideDetails)
* **Ride statistics** displayed next to name:
  * Number of rides organized (completed, not cancelled)
  * Number of rides joined (as participant, completed, not cancelled)
* **Format:** `üë§ David Cohen ¬∑ 5 organized ¬∑ 12 joined`
* **Purpose:** Build trust, help users identify known/experienced riders
* **Foundation:** Ready for clickable profiles (not yet implemented)

#### Notifications System
* **Backend:** Supabase webhooks ‚Üí Edge Functions ‚Üí Expo Push API
* **Mobile:** Auto-refreshing push tokens on app start/login
* **Events:** Join requests, approvals/rejections, ride cancellations
* **Android:** Custom notification channels with high priority
* **Verified:** All notification flows tested end-to-end

#### UI/UX Design System
* **Unified Dark Theme:**
  * Header background: #121212
  * Tab bar background: #121212
  * White inactive icons, orange active icons
  * Consistent across all screens
  
* **Consistent Chip Styling:**
  * 6px gap spacing (optimized for space)
  * Orange theme color for selections
  * Material Design 3 components throughout
  
* **ProfileScreen:**
  * Removed duplicate heading
  * 4 ride types (Trail merged from XC+Trail)
  * RTL button order support
  * Validation: at least one ride type required
  * Birth year placeholder-only behavior
  
* **Create Ride Wizard:**
  * Unified chip styling across all steps
  * Gender preference with chips
  * Review step shows gender preference
  * Optimized spacing (16px between sections)
  
* **Feed & Ride Cards:**
  * Gender preference shown inline (only when not "All")
  * Organizer display with statistics
  * Compact, scannable design
  * Reduced duplicate information

#### Real-Time Updates ‚≠ê NEW
* **MyRidesScreen:** Automatic updates when:
  * Someone joins/requests to join your ride
  * You get approved for a ride
  * A ride is cancelled
  * Participant status changes
* **RideDetailsScreen:** Automatic updates when:
  * Participants join/leave
  * Requests are approved/rejected
  * Ride details change
* **Implementation:** Supabase real-time subscriptions with proper cleanup
* **Result:** No manual refresh needed, instant multi-device sync

#### Persistent User Preferences ‚≠ê NEW
* **Feed Filters:** Automatically saved to AsyncStorage
  * Ride types selection
  * Skill level selection
  * Time range preference
* **Restored on app start** - seamless UX
* **No extra UI** - works transparently

#### Internationalization
* Hebrew and English fully supported
* RTL/LTR handling with native I18nManager
* App restart required for language/direction changes
* All UI strings translated
* Localized date/time formatting

#### Theme Support
* Light, Dark, and System theme modes
* Persistent theme preference
* Smooth theme switching
* Optimized for dark mode (primary UI)

### üìã Known Limitations (Intentional MVP Decisions)

* No ride editing after creation
* No in-app chat (WhatsApp used instead)
* No distance-based sorting (future)
* No GPS tracking during rides
* No media uploads
* No ratings or reviews
* No "I'm at the spot" button
* RTL chip alignment (minor visual issue in Hebrew, functional but not perfectly right-aligned)
* **No clickable profiles yet** (foundation exists, awaiting user feedback)
* **Ride stats fetched on-demand** (N+1 queries, acceptable for MVP scale)

### üß™ Testing Status

* **Devices:** Tested on physical Android devices
* **Scenarios Verified:**
  * End-to-end ride creation and joining flow
  * Express join (instant) vs Approval join (request/approve)
  * Notifications for all event types
  * Gender-based ride filtering
  * Real-time participant updates (multi-device)
  * Deep links (cold start and warm start)
  * Persistent filters across app restarts
  * Organizer statistics display
* **Known Issues:** None critical (RTL alignment is cosmetic)

### üîß Technical Debt & Future Optimization

#### TODO: Ride Statistics Performance Optimization
**Current Implementation:**
* Ride stats fetched on-demand using `getUserOrganizedRidesCount()` and `getUserJoinedRidesCount()`
* Feed with 50 rides, 30 unique owners = 60 COUNT queries (2 per owner)
* Acceptable for MVP (<100 active users)

**Future Optimization (When Needed):**
```sql
-- Add counter fields to profiles table
ALTER TABLE profiles 
ADD COLUMN rides_organized_count INTEGER DEFAULT 0,
ADD COLUMN rides_joined_count INTEGER DEFAULT 0;
```

**Implementation Plan:**
1. Add counter columns to profiles table
2. Create Edge Function or scheduled job:
   - Run daily (or when ride completes)
   - Count past rides for each user
   - Update counter fields
3. Remove real-time count fetching
4. Return counters directly from profiles join (instant, 1 query)

**Migration:**
- Backfill existing counts with one-time script
- Add automated counter maintenance
- Switch from on-demand to cached counts

#### TODO: Automated Ride Status Management
**Current:**
* Rides remain `published` after end time
* Manual counting: `start_at < NOW() AND status != 'cancelled'`

**Future:**
* Scheduled job to update `status = 'completed'` after ride ends
* Enables better analytics and ride history features
* Simplifies counting logic

---

## 4. Execution Plan (TODO)

### Immediate (This Week)

#### Beta Testing Phase
- [ ] Build signed APK
- [ ] Share APK via WeTransfer with 2-3 friends
- [ ] Collect initial feedback on:
  - Ride discovery flow
  - Join/approval experience
  - Notification clarity
  - Overall UX
  - Value of organizer statistics

#### Bug Fixes & Polish (If Needed)
- [ ] Address any critical issues from beta testing
- [ ] Fix RTL chip alignment (if users complain)
- [ ] Improve error messages based on feedback

### Near-Term (Next 2 Weeks)

#### User Profiles (Phase 1) - Based on Feedback
**Decision Point:** Implement only if beta testers ask "Who is this person?"

If yes, implement:
- [ ] Create UserProfileScreen component
- [ ] Make organizer name clickable in Feed and RideDetails
- [ ] Show basic profile:
  - Display name
  - Bio (if exists)
  - Ride preferences (types, skill, pace)
  - Statistics (organized/joined counts)
  - Home region (if provided)
- [ ] Add "View Profile" option in ride details

**Explicitly NOT included in Phase 1:**
- User search
- Following users
- Past ride history (just counts)
- Profile editing by others
- Ratings or reviews

#### WhatsApp Group Integration
- [ ] Add optional WhatsApp group link field to ride creation
- [ ] Display WhatsApp group link in ride details for participants
- [ ] Update review step to show group link if provided

#### Analytics & Monitoring
- [ ] Set up basic analytics:
  - Ride creation rate
  - Join/approval conversion rate
  - Deep link click-through rate
  - Notification open rate
- [ ] Error tracking (Sentry or similar)
- [ ] Performance monitoring

### Medium-Term (1-2 Months)

#### Performance Optimization
- [ ] Implement counter fields for ride statistics (if user base grows)
- [ ] Add automated ride status updates (completed/cancelled)
- [ ] Optimize database queries based on usage patterns

#### Ride Editing
- [ ] Allow ride creator to edit ride details before ride starts
- [ ] Notify participants of changes
- [ ] Handle edge cases (participants leaving after changes)

#### Enhanced Discovery
- [ ] Distance-based sorting (requires user location)
- [ ] Map view of nearby rides
- [ ] "Rides near me" filter option

#### User Experience Improvements
- [ ] Empty state illustrations
- [ ] Loading skeletons instead of spinners
- [ ] Improved ride card visual hierarchy
- [ ] Better date/time pickers

### Long-Term (3+ Months) - Based on Growth

#### Social Features (If Demand Exists)
- [ ] User search functionality
- [ ] Following system
- [ ] Activity feed (friends' rides)
- [ ] Ride history (past rides with details)
- [ ] Trust/reputation system (soft scoring)

#### Advanced Features
- [ ] Recurring rides (weekly group rides)
- [ ] Ride templates (save frequently used settings)
- [ ] Route planning integration
- [ ] Weather forecast integration
- [ ] Ride difficulty calculator

#### Platform Expansion
- [ ] iOS app (if Android version proves successful)
- [ ] Web dashboard for ride management
- [ ] Admin/moderation tools

---

## Session History

### Session: January 6-7, 2026 - Organizer Display & Statistics

**Completed:**
* **Deep Link Functionality:**
  - Fixed warm start freeze issue
  - Resolved route pattern conflicts (`ride/:rideId` made unique per stack)
  - Removed duplicate manual deep link handler
  - Verified cold and warm start scenarios
  
* **Gender Preference Display:**
  - Added to Feed cards (compact, inline, only when not "All")
  - Added to MyRides cards
  - Added to RideDetails screen
  - Consistent display across all screens
  
* **Persistent Feed Filters:**
  - Implemented AsyncStorage-based filter persistence
  - Automatic save on "Apply"
  - Automatic restore on app start
  - No extra UI needed
  
* **Real-Time Updates:**
  - Added Supabase subscriptions to MyRidesScreen
  - Listens to ride_participants and rides table changes
  - Verified RideDetailsScreen subscriptions working
  - Tested multi-device sync scenarios
  
* **Organizer Display & Statistics:**
  - Added foreign key: rides.owner_id ‚Üí profiles.id
  - Created helper functions:
    - `getUserOrganizedRidesCount(userId)` - counts past organized rides
    - `getUserJoinedRidesCount(userId)` - counts past joined rides
  - Updated Ride type to include:
    - `owner_display_name?: string`
    - `owner_rides_organized?: number`
    - `owner_rides_joined?: number`
  - Modified 4 fetch functions to join with profiles and fetch stats:
    - `listFilteredRides` (Feed)
    - `getMyOrganizingRides` (MyRides - Organizing)
    - `getMyJoinedRides` (MyRides - Joined)
    - `getMyRequestedRides` (MyRides - Requested)
  - Updated UI in FeedScreen and RideDetailsScreen to display organizer + stats
  - Format: `üë§ David Cohen ¬∑ 5 organized ¬∑ 12 joined`

**Technical Decisions:**
* Used on-demand stat fetching (Option A) for MVP
  - Acceptable performance for <100 users
  - Marked as TODO for future counter field optimization
* Ride status remains `published` after end time
  - Count logic: `start_at < NOW() AND status != 'cancelled'`
  - Future: Automated status updates to `completed`
* Deep link strategy: External links ‚Üí FeedStack, internal nav maintains context
* Profile visibility: Display name + stats only (no clickable profiles yet)
  - Testing demand before building full profile features

**Testing:**
* ‚úÖ Deep links (cold + warm start)
* ‚úÖ Real-time updates (2-device verification)
* ‚úÖ Gender preference filtering
* ‚úÖ Organizer display with accurate statistics
* ‚úÖ Persistent filters across restarts

### Session: January 5, 2026 - UI/UX Polish

**Completed:**
* ProfileScreen polish (removed duplicate heading, merged XC+Trails, RTL support, validation, birth year fix)
* StepDetails polish (unified chip styling, spacing improvements)
* StepGroup polish (gender preference chips)
* StepReview (added gender preference display)
* MyRidesScreen (added gender preference display, removed duplicate header)
* RideDetailsScreen (added gender preference display)
* Consistent design system across all screens
* Dark theme implementation (#121212 headers and tab bar)

**Key Decisions:**
* Standardized on 6px chip gaps (down from 8px)
* Merged "XC" and "Trail" into single "Trail" category (4 types total)
* Removed duplicate UI elements for cleaner interface
* Validated critical fields (at least one ride type required)

### Previous Sessions - Key Achievements

**Notifications System (December 2025):**
* Implemented end-to-end push notification pipeline
* Supabase webhooks ‚Üí Edge Functions ‚Üí Expo Push API
* Self-healing token sync on app start
* Android notification channels with custom sounds
* Verified all notification types working

**Gender Preferences Feature (December 2025):**
* Added gender_preference to rides table (all/men/women)
* Profile gender selection (Male/Female/Other)
* Automatic feed filtering based on viewer's gender
* Privacy-focused implementation (filter by viewer, not by creator)

**Core Features (November-December 2025):**
* Phone OTP authentication
* Ride creation wizard (5 steps)
* Feed with smart filtering
* My Rides with status tracking
* Real-time participant updates
* Map integration (Israel Hiking Map)
* Bilingual support (Hebrew/English)
* Theme support (Light/Dark/System)

---

## Quick Reference

### Current Ride Types
1. Trail (merged from XC + Trail)
2. Enduro
3. Gravel
4. Road

### Gender Preference Logic
* **All:** Visible to everyone
* **Men:** Visible only to male users
* **Women:** Visible only to female users
* **Other/Null gender users:** See only "All" rides

### Status Badges
* **Orange (#FF6B35):** Owner/Organizing
* **Green (#4CAF50):** Joined
* **Yellow (#FFC107):** Requested/Pending

### Organizer Statistics
* **Organized Count:** Past rides where user was owner (start_at < NOW, status != 'cancelled')
* **Joined Count:** Past rides where user was participant (joined status, not owner, start_at < NOW, status != 'cancelled')
* **Display:** `üë§ Name ¬∑ X organized ¬∑ Y joined`

### Deep Link Patterns
* **External shares:** `bishvil://ride/:rideId` ‚Üí FeedStack ‚Üí RideDetails
* **MyRides internal:** `my-rides/ride/:rideId` ‚Üí MyRidesStack ‚Üí RideDetails
* **Supported prefixes:** `bishvil://`, `https://bishvil.app`, `https://bishvil-app.vercel.app`

### Database Foreign Keys
* `rides.owner_id` ‚Üí `profiles.id` (rides_owner_profile_id_fkey)
* `ride_participants.ride_id` ‚Üí `rides.id`
* `ride_participants.user_id` ‚Üí `profiles.id`
* `profiles.id` ‚Üí `auth.users.id`

### Key File Locations
* Profiles: `src/lib/profile.ts`
* Rides: `src/lib/rides.ts`
* Ride Statistics: `getUserOrganizedRidesCount()`, `getUserJoinedRidesCount()` in `rides.ts`
* Notifications: `src/lib/notifications.ts`
* Auth: `src/lib/supabase.ts`
* Navigation: `src/app/navigation/AppNavigator.tsx`
* Deep Linking: `src/app/navigation/linking.ts`
* i18n: `src/app/i18n/`

---

**Last Updated:** January 7, 2026  
**Status:** Production-ready MVP with social trust features  
**Next Milestone:** Beta testing with 2-3 users, gather feedback on organizer visibility