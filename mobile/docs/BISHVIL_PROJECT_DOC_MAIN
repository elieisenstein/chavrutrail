# Bishvil â€“ Project Documentation

*Last updated: 2026-01-05*

This document consolidates the project documentation into four clear layers:

1. **Product Specification** â€“ what the product is and is not
2. **Architecture & Decisions** â€“ stable, longâ€‘term choices
3. **Current Status** â€“ factual snapshot of where the project stands
4. **Execution Plan (TODO)** â€“ forwardâ€‘looking, actionable work

---

## 1. Product Specification (Stable)

### Purpose

Bishvil is an **Androidâ€‘first mobile app** for organizing and joining cycling rides in Israel (MTB / Gravel / Road), optimized for *operational compatibility* (pace, skill, timing, gender preferences) rather than social networking.

### Core Principles

* Fast ride discovery and joining
* Low friction, minimal ceremony
* Privacyâ€‘first (no phone exposure)
* Hebrewâ€‘first with full RTL/LTR support
* Gender-aware ride filtering for safety and comfort

### Target Platform

* Android first (APK distribution via direct download)
* iOS later (no architectural blockers)

### MVP Scope

* Ride creation and discovery
* Join / approval flows
* Profiles (lightweight, preference-based)
* Mapâ€‘based location selection (Israel Hiking Map)
* Bilingual UI (Hebrew / English)
* Push notifications for ride events
* Gender-based ride filtering

### Explicitly Out of Scope (MVP)

* GPS ride tracking during rides
* Media uploads (photos/videos)
* Social feeds, likes, ratings
* Internal moderation tools
* In-app chat (WhatsApp used instead)
* Ride editing after creation

### KPIs (Pilot)

* Time to first joined ride
* % of rides that actually happen
* Repeat rides with the same participants
* Notification engagement rate

---

## 2. Architecture & Decisions (Longâ€‘Term)

### Mobile Stack

* **Framework:** React Native + Expo SDK 52 (TypeScript)
* **UI Library:** react-native-paper (Material Design 3)
* **Navigation:** React Navigation (native stack + bottom tabs)
* **Design:** Stravaâ€‘inspired, clean, functional aesthetic

### Backend

* **Platform:** Supabase
  * Auth: Phone OTP (email fallback for development)
  * PostgreSQL with Row Level Security (RLS)
  * Realtime subscriptions for live updates
  * Edge Functions for notifications
  * Database webhooks for event triggers

### Authentication

* Phone OTP primary (Israeli norm, high completion)
* Email auth for development/testing
* Sessions persist across app restarts
* Auto-refresh of push tokens on login

### Data Model

#### Core Tables
* `profiles` - User profiles (separate from auth.users)
  * Auto-created via DB trigger
  * Contains: display_name, bio, ride_type[], skill, pace, birth_year, gender, expo_push_token
* `rides` - Ride listings
  * Contains ride details, location, preferences, gender_preference
* `ride_participants` - Join/approval tracking
  * Tracks status: joined, requested, rejected, left, kicked

### Privacy Decisions

* Phone numbers never exposed to other users
* Display name is the only visible identity
* Future contact via inâ€‘app notifications or WhatsApp link only
* No public profiles or social feeds

### Maps & Location

* **Provider:** Mapbox GL (native build required)
* **Tiles:** Israel Hiking Map with colored trail overlays
* **Features:**
  * Full-screen map picker for ride creation
  * Interactive map preview in ride details
  * Text description + GPS coordinates required
  * External navigation (Google Maps / Waze)
* **Design Decision:** No reverse geocoding (user provides text description)

### Notifications

* **Provider:** Expo Push Notifications + Firebase Cloud Messaging
* **Architecture:**
  * Supabase Database Webhooks â†’ Edge Function â†’ Expo Push API
  * Token stored in profiles table, auto-refreshed on app start
  * Android notification channels for categorization
* **Events:**
  * Join requests (to owner)
  * Approval/rejection (to requester)
  * Ride cancellation (to all participants)
  * Ride updates (future)

### Internationalization

* **Languages:** Hebrew (primary), English
* **Implementation:** react-i18next
* **RTL Handling:** Native I18nManager.forceRTL() with app restart requirement
* **Date/Time:** Localized using he-IL formatting

### Deferred Backend (Reserved)

* FastAPI (Python) for future needs:
  * Moderation tools
  * Trust scoring algorithms
  * Scheduled cleanup jobs
  * External service integrations

---

## 3. Current Project Status (Snapshot)

**Stage:** Polish & Refinement Phase (Production-ready MVP)

### âœ… Completed Core Features

#### Authentication & Profiles
* Phone OTP authentication with persistent sessions
* Profile auto-creation via DB trigger
* Lightweight profile with ride preferences
* Gender selection (Male/Female/Other)
* Birth year collection
* Ride type preferences (Trail, Enduro, Gravel, Road)
* Skill level and pace preferences

#### Ride Creation & Management
* 5-step wizard (When/Where/Details/Group/Review)
  * Date/time picker with duration
  * Full-screen map location picker (Israel Hiking Map)
  * Ride type, skill level, pace selection
  * Distance and elevation (optional)
  * Max participants (1-6, recommendation for 4)
  * Join mode (Express/Approval)
  * Gender preference (All/Men/Women)
* Owner can cancel rides (notifies all participants)
* Participants can leave rides
* Real-time participant count updates

#### Feed & Discovery
* Smart filtering by:
  * User's preferred ride types (auto-loaded from profile)
  * User's gender (automatic gender-based visibility)
  * Skill level (optional)
  * Time range (Today, 3d, 7d, 14d, 30d)
* Empty states with helpful CTAs
* Pull-to-refresh
* Real-time updates via Supabase subscriptions

#### My Rides
* Three sections with visual status indicators:
  * Organizing (orange badge)
  * Joined (green badge)
  * Requested (yellow badge)
* Empty states per section
* Status-specific ride cards

#### Ride Details
* Complete ride information display
* Israel Hiking Map preview
* Participant list with owner indicator
* Pending requests section (owner only)
* Approve/reject buttons (owner only)
* Join/Leave actions
* External navigation (Google Maps/Waze)
* WhatsApp share functionality
* Gender preference display

#### Notifications System
* **Backend:** Supabase webhooks â†’ Edge Functions â†’ Expo Push API
* **Mobile:** Auto-refreshing push tokens on app start/login
* **Events:** Join requests, approvals/rejections, ride cancellations
* **Android:** Custom notification channels with high priority
* **Verified:** All notification flows tested end-to-end

#### UI/UX Polish (Latest Session - Jan 5, 2026)
* **Unified Design System:**
  * Consistent chip styling across all screens
  * Orange theme color for selections
  * 6px gap spacing (reduced from 8px)
  * Material Design 3 components throughout
  
* **ProfileScreen:**
  * Removed duplicate heading
  * Merged XC + Trails â†’ just "Trails" (4 ride types)
  * RTL button order support (arrays reversed for Hebrew)
  * Validation: at least one ride type required
  * Birth year placeholder-only behavior
  
* **Create Ride Wizard:**
  * StepDetails: Replaced buttons with chips for consistency
  * StepGroup: Gender preference with chips
  * StepReview: Gender preference display added
  * Increased spacing between sections (16px)
  * Extra spacing between Pace and Distance fields
  
* **MyRidesScreen & RideDetailsScreen:**
  * Gender preference display added
  * Consistent with create flow

#### Internationalization
* Hebrew and English fully supported
* RTL/LTR handling with native I18nManager
* App restart required for language/direction changes
* All UI strings translated
* Localized date/time formatting

#### Theme Support
* Light, Dark, and System theme modes
* Persistent theme preference
* Smooth theme switching

### ðŸ“‹ Known Limitations (Intentional MVP Decisions)

* No ride editing after creation
* No in-app chat (WhatsApp used instead)
* No distance-based sorting (future)
* No GPS tracking during rides
* No media uploads
* No ratings or reviews
* No "I'm at the spot" button
* RTL chip alignment (minor visual issue in Hebrew, functional but not perfectly right-aligned)

### ðŸ§ª Testing Status

* **Devices:** Tested on physical Android devices
* **Auth:** Real OTP flow verified (Twilio Verify)
* **Multi-user:** Validated with multiple test accounts
* **Notifications:** End-to-end tested for all event types
* **Maps:** Verified on real devices with GPS
* **APK:** Signed APKs ready for distribution

### ðŸŽ¨ Design System

* **Colors:** Orange primary theme (Strava-inspired)
* **Typography:** Material Design 3 defaults
* **Components:** react-native-paper throughout
* **Spacing:** Consistent 6px chip gaps, 16px section spacing
* **Status Badges:**
  * Owner: Orange (#FF6B35)
  * Joined: Green (#4CAF50)
  * Requested: Yellow (#FFC107)

---

## 4. Execution Plan (TODO â€“ Forward Looking)

### Immediate Next Steps (Phase 1 - APK Distribution)

**Goal:** Get first 10 beta testers using the app

* [ ] Finalize APK signing and distribution method
* [ ] Create simple landing page with download link
* [ ] Test APK installation on various Android versions
* [ ] Set up basic crash reporting (Sentry or similar)
* [ ] Create user onboarding flow documentation

### Priority 2 â€“ Enhanced Coordination

**Goal:** Improve ride coordination and communication

* [ ] WhatsApp group link per ride (owner can add)
* [ ] Ride editing for owner (notify participants of changes)
* [ ] "Confirm attendance" feature 24h before ride
* [ ] Phone number visibility toggle (opt-in for participants)

### Priority 3 â€“ Feed Improvements

**Goal:** Better discovery and matching

* [ ] Distance-based sorting (requires user home location)
* [ ] Save home location in profile
* [ ] "Near me" filter
* [ ] Ride recommendations based on profile

### Priority 4 â€“ Data & Cleanup

**Goal:** Maintain clean database and improve UX

* [ ] Auto-archive rides after end time (status: completed)
* [ ] Auto-cancel rides with no participants 24h before start
* [ ] Cleanup old notifications
* [ ] Basic analytics dashboard

### Future Enhancements (Post-MVP)

* Trust score system (completed rides, cancellation rate)
* In-app chat (if WhatsApp proves insufficient)
* Ride templates for repeat organizers
* Group/club features
* Premium features (ride series, advanced filters)

### Explicitly Postponed

* GPS ride tracking and recording
* Media uploads (photos/videos from rides)
* Public ratings and reviews
* Complex moderation tools
* iOS version (until Android validates product-market fit)

---

## 5. Technical Debt & Issues

### Minor Issues
* **RTL Chip Alignment:** Hebrew chips align left instead of right (functional but not ideal)
  * Impact: Low (purely visual, doesn't affect usability)
  * Priority: Low (polish for future release)

### Migration Notes
* Users who selected "XC" before the merge will see it removed on next profile edit
* No database migration needed (handled in app logic)

### Performance Considerations
* Feed query performance is good for <1000 rides
* May need indexing if user base grows significantly
* Real-time subscriptions are lightweight (only participants table)

---

## 6. Development Practices

### Code Organization
* Feature-based folder structure
* Shared components in `/components`
* API calls in `/lib` modules
* Type definitions co-located with features

### Type Safety
* Full TypeScript coverage
* Strict mode enabled
* Supabase types auto-generated

### State Management
* React hooks (useState, useEffect)
* No global state library (intentional simplicity)
* Real-time updates via Supabase subscriptions

### Error Handling
* Try-catch blocks for all async operations
* User-friendly error messages
* Console logging for debugging

---

## 7. Ownership & Contact

**Developer:** Eli Eisenstein  
**Project:** Bishvil (×‘×©×‘×™×œ - "For the trail")  
**Current Phase:** Polish & Beta Testing  
**Started:** 2025  
**Current Focus:** APK distribution and first pilot users

---

## 8. Session History & Progress Log

### Session: January 5, 2026 - UI/UX Polish & Gender Preferences

**Completed:**
* ProfileScreen polish (removed duplicate heading, merged XC+Trails, RTL support, validation, birth year fix)
* StepDetails polish (unified chip styling, spacing improvements)
* StepGroup polish (gender preference chips)
* StepReview (added gender preference display)
* MyRidesScreen (added gender preference display)
* RideDetailsScreen (added gender preference display)
* Consistent design system across all screens

**Key Decisions:**
* Standardized on 6px chip gaps (down from 8px)
* Merged "XC" and "Trail" into single "Trail" category (4 types total)
* Removed duplicate UI elements for cleaner interface
* Validated critical fields (at least one ride type required)

### Previous Sessions - Key Achievements

**Notifications System (December 2025):**
* Implemented end-to-end push notification pipeline
* Supabase webhooks â†’ Edge Functions â†’ Expo Push API
* Self-healing token sync on app start
* Android notification channels with custom sounds
* Verified all notification types working

**Gender Preferences Feature (December 2025):**
* Added gender_preference to rides table (all/men/women)
* Profile gender selection (Male/Female/Other)
* Automatic feed filtering based on viewer's gender
* Privacy-focused implementation (filter by viewer, not by creator)

**Core Features (November-December 2025):**
* Phone OTP authentication
* Ride creation wizard (5 steps)
* Feed with smart filtering
* My Rides with status tracking
* Real-time participant updates
* Map integration (Israel Hiking Map)
* Bilingual support (Hebrew/English)
* Theme support (Light/Dark/System)

---

*End of documentation*

## Quick Reference

### Current Ride Types
1. Trail (merged from XC + Trail)
2. Enduro
3. Gravel
4. Road

### Gender Preference Logic
* **All:** Visible to everyone
* **Men:** Visible only to male users
* **Women:** Visible only to female users
* **Other/Null gender users:** See only "All" rides

### Status Badges
* **Orange:** Owner/Organizing
* **Green:** Joined
* **Yellow:** Requested/Pending

### Key File Locations
* Profiles: `src/lib/profile.ts`
* Rides: `src/lib/rides.ts`
* Notifications: `src/lib/notifications.ts`
* Auth: `src/lib/supabase.ts`
* i18n: `src/app/i18n/`

---

**Last Reshaped:** January 5, 2026  
**Status:** Ready for beta testing


Summary of Today's Accomplishments:
âœ… Header & Footer Styling

Dark theme (#121212) for headers and tab bar
White inactive icons, orange active icons
Consistent across all screens

âœ… Deep Link Fix

Fixed warm start freeze issue
Resolved route pattern conflict
Deep links now work perfectly in both cold and warm starts

âœ… Gender Preference Display

Added to Feed cards (only shows when not "All")
Compact, single-line display
Consistent with MyRides and RideDetails

âœ… Persistent Feed Filters

Filters now save automatically to AsyncStorage
Load on app start
No extra UI needed - just works!

âœ… UI Polish

Removed duplicate "My Rides" header
Clean, Strava-inspired dark interface
Improved screen real estate usage