# Bishvil ‚Äì Project Documentation (Reshaped)

*Last reshaped: 2026-01-02*

This document consolidates and restructures the project documentation into four clear layers:

1. **Product Specification** ‚Äì what the product is and is not
2. **Architecture & Decisions** ‚Äì stable, long‚Äëterm choices
3. **Current Status** ‚Äì factual snapshot of where the project stands
4. **Execution Plan (TODO)** ‚Äì forward‚Äëlooking, actionable work

The content below was **moved and deduplicated** from the original documents to ensure each section has a single responsibility.

---

## 1. Product Specification (Stable)

### Purpose

Bishvil is an **Android‚Äëfirst mobile app** for organizing and joining cycling rides in Israel (MTB / Gravel / Road), optimized for *operational compatibility* (pace, skill, timing) rather than social networking.

### Core Principles

* Fast ride discovery and joining
* Low friction, minimal ceremony
* Privacy‚Äëfirst (no phone exposure)
* Hebrew‚Äëfirst with full RTL/LTR support

### Target Platform

* Android first (APK distribution)
* iOS later (no architectural blockers)

### MVP Scope

* Ride creation and discovery
* Join / approval flows
* Profiles (lightweight)
* Map‚Äëbased location selection
* Bilingual UI (Hebrew / English)

### Explicitly Out of Scope (MVP)

* GPS ride tracking
* Media uploads
* Social feeds, likes, ratings
* Internal moderation tools

### KPIs (Pilot)

* Time to first joined ride
* % of rides that actually happen
* Repeat rides with the same participants

---

## 2. Architecture & Decisions (Long‚ÄëTerm)

### Mobile Stack

* React Native + Expo (TypeScript)
* react-native-paper (Material Design 3)
* Design‚Äësystem driven (Strava‚Äëlike feel)

### Backend

* Supabase

  * Auth: Phone OTP (Twilio Verify)
  * PostgreSQL + RLS
  * Realtime (future chat / notifications)

### Authentication

* Phone OTP only (Israeli norm, high completion)
* No email auth in MVP
* Sessions persist across restarts

### Profiles

* `profiles` table separate from `auth.users`
* Auto‚Äëcreated via DB trigger
* Phone number not duplicated in app tables

### Privacy Decisions

* Phone numbers never exposed to other users
* Display name is the only visible identity
* Future contact via in‚Äëapp or WhatsApp link only

### Maps

* Mapbox GL (native build)
* Israel Hiking Map tiles
* Text + map pin required
* No reverse geocoding by design

### Deferred Backend (Reserved)

* FastAPI (Python) for:

  * moderation
  * trust scoring
  * scheduled jobs
  * external integrations

---

## 3. Current Project Status (Snapshot)

**Stage:** Pilot‚Äëready MVP (Production‚Äëready)

### What Works End‚Äëto‚ÄëEnd

* Phone OTP authentication
* Persistent sessions
* Profile auto‚Äëcreation
* Ride creation wizard (When / Where / Details / Group / Review)
* Join & approval flows
* Owner cancel & participant leave
* Real‚Äëtime participant counts
* Feed with filters and empty states
* Hebrew / English with stable RTL/LTR
* Light / Dark / System themes

### Maps & Location

* Full Mapbox integration (native build)
* Israel Hiking tiles with colored trails
* Full‚Äëscreen map picker
* Correct coordinate persistence
* External navigation (Google Maps / Waze)

### Navigation

* 4 tabs: Feed, My Rides, Create, Profile
* My Rides sections:

  * Organizing
  * Joined
  * Requested

### Production Readiness

* Tested on physical Android devices
* Real OTP flow verified
* Multi‚Äëuser scenarios validated
* Signed APKs ready for distribution

### Known Limitations (Intentional)

* No push notifications yet
* No in‚Äëapp chat
* No ride editing
* No distance sorting

---

## 4. Execution Plan (TODO ‚Äì Forward Looking)

### Priority 1 ‚Äì Engagement Foundation

**Goal:** Prove notification & coordination value

* Test full approval notification flow
* Enforce phone number collection on join
* Personalize feed by home region / ride type

### Priority 2 ‚Äì Social Bridge

**Goal:** Get users into real coordination

* WhatsApp group link per ride
* Edit ride & notify participants

### Priority 3 ‚Äì Refinement

**Goal:** Prepare first 10 testers

* Multi‚Äëdevice testing
* Ride auto‚Äëcleanup (past rides)
* Simplified onboarding (forced home region)

### Explicitly Postponed

* Internal chat (WhatsApp used instead)
* Media uploads
* Ratings / reviews
* "I‚Äôm at the spot" button

---

## Ownership

**Developer:** Eli Eisenstein
**Project:** Bishvil
**Current Focus:** Pilot validation & engagement

---

*End of reshaped documentation*

üèÜ Final Achievement Summary for your Status Doc
We have now fully stabilized the end-to-end notification pipeline. Here is the breakdown of the successful architecture:

1. Backend & Event Logic
Automated Triggers: The Supabase Database Webhook accurately detects changes in ride_participants (joins/leaves) and rides (cancellations/updates).

Edge Function Reliability: The process-ride-event function correctly calls the send-notification service. We resolved the 401 Unauthorized issue by disabling JWT verification for internal service-to-service calls.

Expo API Integration: Successfully authenticated with Expo‚Äôs servers using the EXPO_ACCESS_TOKEN, verified by {"status": "ok"} responses in the logs.

2. Mobile App Infrastructure
Self-Healing Token Sync: Updated App.tsx and notifications.ts to automatically refresh the expo_push_token in the Supabase profiles table every time the app initializes or a user logs in.

Robust User Identification: Switched to supabase.auth.getUser() to ensure the push token is always mapped to the correct user ID, even during cold starts.

Android Channel Optimization: Implemented specific notification channels (e.g., "Requests & Approvals", "Ride Updates") with AndroidImportance.HIGH to ensure pop-up alerts and custom sounds.

3. Verified Use Cases
‚úÖ Join Requests: Owner is notified when a user requests to join.

‚úÖ Approvals/Rejections: Participants are notified of the owner's decision.

‚úÖ Ride Cancellations: All participants are successfully broadcasted a notification if a ride is cancelled.

Next Objective: Address UI state refreshing to ensure screens update automatically when a notification is received or an action is performed.
